<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>First frame</title>
    <!-- stylesheet from bootstrap -->
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='creative.min.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='creative.css') }}">

    <!-- stylesheet -->
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='first_frame.css') }}">

    <!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

    <script>
	(function(s,u,r,f,l,y){s[f]=s[f]||{init:function(){s[f].q=arguments}};
	l=u.createElement(r);y=u.getElementsByTagName(r)[0];l.async=1;
	l.src='https://surfly-s1.com/surfly.js';y.parentNode.insertBefore(l,y);})
	(window,document,'script','Surfly');
    </script>

    <script>
	var settings = {widgetkey:'b84defc4621441ecae5eb10bdec1cb5a', block_until_agent_joins: false};
	window.addEventListener('DOMContentLoaded', function() {
	  Surfly.init(settings, function(init) {
	    if (init.success) {
	      if(!Surfly.currentSession){
		      Surfly.session()
			.on('session_started', function(session) {
			       // get the session id from the follower link
				var followerLink = session.followerLink;
				var linkIndex = followerLink.indexOf(".com");
				var sessionID = followerLink.substring(linkIndex+4, linkIndex+16);
				// get the page url
				var pageUrl = document.location.href;
				var pageIndex = pageUrl.indexOf("https");
				var pageEnd = pageUrl.indexOf("first_frame");
				var fullPageUrl = pageUrl.substring(pageIndex, pageEnd-1);
				// append the page url to the session id
				var res = fullPageUrl.concat('/splitscreen', sessionID);

				// send the link to the top page (popup)
                                var popupWindow = document.getElementById('popupWindow').contentWindow;
                                popupWindow.postMessage("link to open: " + res, "*");
		      })
		      .startLeader();
		} 
	     }
	   });
	 });
    </script>

</head>


<body id="page-top">
    <header>
        <div class="header-content">
            <div class="header-content-inner">
                <h1 id="homeHeading">Invite a friend!</h1>
                <hr>
                <p>Click on the link below to invite someone to join your splitscreen session</p>
                <button class="btn btn-primary btn-xl page-scroll" onclick="showLink()">Invite!</button>
            </div>
        </div>
    </header>

   <!-- find out how to put the iframe on top of the rest of the page so it looks like a popup -->
<iframe id="popupWindow" style="width: 100px; height: 100px; top: 50px;    left: 50px;    display: block;  visibility:hidden;  position: absolute;" src="./popup_link">
</iframe>

   <script>
    function showLink() {
       document.getElementById("popupWindow").style.visibility = 'visible';
    }
   </script>

   <script>
	window.addEventListener('message', function(e){
		// listen for the follower link 
		var string = JSON.stringify(e.data);
		if(string.indexOf('cobro_event')){
			if (string.match(/[0-9]{3}[-][0-9]{3}[-][0-9]{3}/)) {
				var index = string.indexOf('https');
				var indexEnd = string.indexOf('origin');	
				var flink = string.substring(index, indexEnd-4);
				window.top.postMessage('flink: ' + flink , '*' );
			}
		}
	})
    </script>
</body>
</html> 
