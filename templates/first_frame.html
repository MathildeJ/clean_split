<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>First frame</title>
    <!-- Bootstrap Core CSS -->
    <link href="../static/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../static/stylish-portfolio.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../static/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <script>
	(function(s,u,r,f,l,y){s[f]=s[f]||{init:function(){s[f].q=arguments}};
	l=u.createElement(r);y=u.getElementsByTagName(r)[0];l.async=1;
	l.src='https://surfly-s1.com/surfly.js';y.parentNode.insertBefore(l,y);})
	(window,document,'script','Surfly');
    </script>

    <script>
	var settings = {widgetkey:'b84defc4621441ecae5eb10bdec1cb5a', block_until_agent_joins: false};
	window.addEventListener('DOMContentLoaded', function() {
	  Surfly.init(settings, function(init) {
	    if (init.success) {
	      if(!Surfly.currentSession){
		      Surfly.session()
			.on('session_started', function(session) {
			       // get the session id from the follower link
				var followerLink = session.followerLink;
				var linkIndex = followerLink.indexOf(".com");
				var sessionID = followerLink.substring(linkIndex+4, linkIndex+16);
				// get the page url
				var pageUrl = document.location.href;
				var pageIndex = pageUrl.indexOf("https");
				var pageEnd = pageUrl.indexOf("first_frame");
				var fullPageUrl = pageUrl.substring(pageIndex, pageEnd-1);
				// append the page url to the session id
                                res = fullPageUrl.concat('/splitscreen', sessionID);
        

		      })
		      .startLeader();
		} 
	     }
	   });
	 });

    // send the link to the top page (popup)
    var popupWindow = document.getElementById('popupWindow').contentWindow;
                                popupWindow.postMessage("link to open: " + res, "*");

    </script>

    <style>
      body {
         background-image: url('../static/sunset.jpg');
      }
      
      #inviteButton {
         background-color: white;
      }
    
      .titleText {
         color: white;
      }

      .mainText {
         color: white;
      }       
 
    </style>

</head>


<body id="page-top">

    <header id="top" class="header">
        <div class="text-vertical-center">
            <h1 class="titleText" style="color: white;">Invite a friend!</h1>
            <h3 class="mainText">Click below to invite someone to join your splitscreen session</h3>
            <br>
            <button id="inviteButton" class="btn btn-dark btn-lg" onclick="showLink()">Invite!</button>
        </div>
    </header>

   <!-- put the iframe on top of the rest of the page so it looks like a popup -->
   <iframe id="popupWindow" style="width: 350px; height: 500px; top: 50px;    left: 50px;    display: block;  visibility:hidden;  position: absolute;" src="./popup_link">
   </iframe> 

   <script>
    function showLink() {
       document.getElementById("popupWindow").style.visibility = 'visible';
    }
   </script>

   <script>
     function closeIframe() {
       document.getElementById("popupWindow").style.visibility = 'hidden';
     }
   </script>
   
   <script>
	window.addEventListener('message', function(e){
		// listen for the follower link 
		var string = JSON.stringify(e.data);
		if(string.indexOf('cobro_event')){
			if (string.match(/[0-9]{3}[-][0-9]{3}[-][0-9]{3}/)) {
				var index = string.indexOf('https');
				var indexEnd = string.indexOf('origin');	
				var flink = string.substring(index, indexEnd-4);
				window.top.postMessage('flink: ' + flink , '*' );
			}
		}
	})
    </script>
</body>
</html> 
