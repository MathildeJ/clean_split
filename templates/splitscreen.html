<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Splitscreen</title>

<link href="../static/splitscreen.css" rel="stylesheet">
<link href="../static/leader_side.css" rel="stylesheet">

<script>
(function(s,u,r,f,l,y){s[f]=s[f]||{init:function(){s[f].q=arguments}};
l=u.createElement(r);y=u.getElementsByTagName(r)[0];l.async=1;
l.src='https://surfly-s1.com/surfly.js';y.parentNode.insertBefore(l,y);})
(window,document,'script','Surfly');
</script>

<script>
var sess;

var settings = {widgetkey:'b84defc4621441ecae5eb10bdec1cb5a', block_until_agent_joins: false};
window.addEventListener('DOMContentLoaded', function() {
  Surfly.init(settings, function(init) {
    if (init.success) {
      	if(!Surfly.currentSession){
	      s = Surfly.session();
	      s._settings.url = "https://www.google.com";
	      s.on('session_started', function(session) {
		       // get the session id from the follower link
			var followerLink = session.followerLink;
			var linkIndex = followerLink.indexOf(".com");
			var sessionID = followerLink.substring(linkIndex+4, linkIndex+16);
			// get the page url
			var pageUrl = document.location.href;
			// append the page url to the session id
			var res = pageUrl.concat(sessionID);

		        var invite_link = document.getElementById('invite');
			var invite = document.getElementById('invite_a');
			invite_link.innerHTML = res;
			invite_link.style.visibility = 'visible';
			invite.href = res;
			invite.style.visibility = 'visible';

			sess = session;
	      	})
		.on('message', function(session, event){
                        console.log(event.data);
			var string = JSON.stringify(event.data);
			if(string.indexOf('cobro_event')){
				if (string.match(/[0-9]{3}[-][0-9]{3}[-][0-9]{3}/)) {
					console.log('ok');
					var index = string.indexOf('https');
					var indexEnd = string.indexOf('origin');	
					var flink = string.substring(index, indexEnd-4);
					console.log(flink);
				}
			}
			document.getElementById('ifrm2').src = link;
			document.getElementById('invite').style.visibility = 'hidden';
			document.getElementById('invite_a').style.visibility = 'hidden';
		}).startLeader('#ifrm1');
	} 
     }
   });
 });


window.addEventListener('message', function(e){
	var string = JSON.stringify(e.data);

	if(string.indexOf('cobro_event')){
		if (string.match(/[0-9]{3}[-][0-9]{3}[-][0-9]{3}/)) {
			var index = string.indexOf('https');
			var indexEnd = string.indexOf('origin');	
			var flink = string.substring(index, indexEnd-4);
			window.top.postMessage('flink: ' + flink , '*' );
		}
	}
	
	if(string.indexOf('test_re')!==-1){
		console.log("ok");
		var site = string.substring(9,string.length-1);
		sess.relocate(site);
	}
})
</script>

</head>

<body>
<div id="form_wrapper" style="visibility:visible;">
	<form id="nav" action="" method="post">
		<h4 class="text-title">Nav bar</h4>
		<label>
			<span>Website :</span>
		        <input id="url" type="text" name="url" />
		</label>
		<label>
		       <input type="button" class="button" id="submit_button" style="cursor:pointer;" onclick=sendMess() value="Go!" />
		</label>
	</form>
</div>
<div id="invite" style="visibility:hidden">Invite link</div>
<a id="invite_a" style="visibility:hidden">Invite link</a>

<div class="box"><iframe id="ifrm1" src="" height="700" width="49%" align='left'></iframe></div>
<div class="box"><iframe id="ifrm2" src="./fourth_frame" height="700" width="49%" align='right' style="background-image: url(../static/beer.jpg); background-size: cover;"></iframe></div>

<script>
function sendMess(){
	var url = document.getElementById('url').value;
	var frame = document.getElementById('ifrm1').contentWindow;
	frame.postMessage('test_re:'+url, '*');
}
</script>

<script>
var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
var eventer = window[eventMethod];
var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

// Listen to message from child IFrame window
eventer(messageEvent, function (e) {
   var info = JSON.stringify(e.data);
   console.log(e.data);
   if(info.indexOf('flink')!==-1){
	var link = e.data.substring(7);
	if(link.indexOf('\\')){ link = link.substring(0, link.length);};
	
   }
}, false);
</script>
</body>

</html>
