<!DOCTYPE html>
<html lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Splitscreen</title>

<link href="../static/splitscreen.css" rel="stylesheet">
<link href="../static/page_top.css" rel="stylesheet">

<script>
(function(s,u,r,f,l,y){s[f]=s[f]||{init:function(){s[f].q=arguments}};
l=u.createElement(r);y=u.getElementsByTagName(r)[0];l.async=1;
l.src='https://surfly-s1.com/surfly.js';y.parentNode.insertBefore(l,y);})
(window,document,'script','Surfly');
</script>

<script>
var sess;
var inviteLink;
var settings = {widgetkey:'b84defc4621441ecae5eb10bdec1cb5a', block_until_agent_joins: false, ui_off: true};
window.addEventListener('DOMContentLoaded', function() {
  Surfly.init(settings, function(init) {
    if (init.success) {
      	if(!Surfly.currentSession){
	      s = Surfly.session();
	      s._settings.url = "https://murmuring-sierra-68089.herokuapp.com/start_page";
	      s.on('session_started', function(session) {
		       // get the session id from the follower link
			var followerLink = session.followerLink;
			var linkIndex = followerLink.indexOf(".com");
			var sessionID = followerLink.substring(linkIndex+4, linkIndex+16);
			// get the page url
			var pageUrl = document.location.href;
			// append the page url to the session id
			inviteLink = pageUrl.concat(sessionID);
                        console.log("the invite link is ", inviteLink);
                        var startWindow = document.getElementById('ifrm1').contentWindow;
                        startWindow.postMessage(inviteLink, "*");
			var inviteButton = document.getElementById('invite');
                        // display the invite link
			//invite_link.innerHTML = "Copy-paste the following link to invite a friend: "+ res;
			//invite_link.style.visibility = 'visible';
			//invite.href = inviteLink;
			inviteButton.style.visibility = 'visible';
			document.getElementById('exit_button').style.visibility="visible";
			sess = session;	
		})
		.on('session_ended', function(session) {
			document.getElementById('exit_button').style.visibility="hidden";
		}).startLeader('#ifrm1');
	} 
     }
   });
 });

function sendMess(){
	var url = document.getElementById('url').value;
	sess.relocate(url);
}

window.addEventListener('message', function(e){
     var origin = event.origin || event.originalEvent.origin;
     if (origin == "https://surfly-s1.com") {
        console.log("passed the test");
        var string = JSON.stringify(e.data);
	if(string.indexOf('cobro_event')){
		if (string.match(/[0-9]{3}[-][0-9]{3}[-][0-9]{3}/)) {
                        // extract the follower link from the message 
			var index = string.indexOf('https');
			var indexEnd = string.indexOf('origin');	
			var flink = string.substring(index, indexEnd-4);
			if(flink.indexOf('\\')){ flink = flink.substring(0, flink.length);};
                        // set the source of the second iframe to the follower link
			document.getElementById('ifrm2').src = flink;
			document.getElementById('invite_a').style.visibility = 'hidden';
		}
	}
    }

})

function exitSession(){
  sess.end('https://www.surfly.com');
}


</script>


<style>
div.relative {
    position: relative;
    width: 400px;
    height: 200px;
    border: 3px solid #73AD21  ;
}

button.absolute {
    position: absolute;
    top: 80px;
    right: 0;
    width: 200px;
    height: 100px;
    border: 3px solid #73AD21  ;
}
</style>

</head>

<body>

<div id="buttContainer">
	<button class="relative" style="visibility:hidden" onclick="exitSession()" id="exit_button">Exit
        <div id="replaceButton"><button id="ignore" onclick="ignoreFriend()" class="absolute">Ignore Friend</div>
        <button  id="acknowledge" onclick="acknowledgeFriend()" style="visibility:hidden" class="absolute">Acknowledge friend
        </button></button></button>
</div>


<!-- navbar -->

<div id="form_wrapper" style="visibility:visible;">
	<form id="nav" action="" method="post">
		<label>
			<h3 id="title_bar">Nav bar :</h3>
		        <input id="url" type="text" name="url" />
		</label>
		<label>
		       <input type="button" class="button" id="submit_button" style="cursor:pointer;" onclick=sendMess() value="Go!" />
		</label>
	</form>
</div>


<!-- display the links at the top of the page -->
<div id="invite" style="visibility:hidden"></div>
<a id="invite_a" style="visibility:hidden">Invite link</a>

<!-- the two iframes -->
<!-- the frame in which the leader link is opened -->
<div class="box"><iframe id="ifrm1" src="" height="700" width="49%" align='left'></iframe></div>
<!-- the frame in which the follower link will be opened -->
<div class="box"><iframe id="ifrm2" src="./fourth_frame" height="700" width="49%" align='right' style="background-image: url(../static/beer.jpg); background-size: cover;"></iframe></div>


<script>
  // ignore friend button
  function ignoreFriend() {
    var friendsFrame = document.getElementById("ifrm2");
    var yourFrame = document.getElementById("ifrm1");
    var ignoreButton = document.getElementById("ignore");
    var acknowledgeButton = document.getElementById("acknowledge");
    // we hide our friends iframe
    friendsFrame.style.visibilty = "hidden";
    // we make our iframe the size of the screen
    yourFrame.style.width = "99%";
    // we replace the ignore button with an acknowledge friend button
    ignoreButton.style.visibility = "hidden";
    document.getElementById("replaceButton").appendChild(acknowledgeButton);
    acknowledgeButton.style.visibility = "visible";
  }
</script>

<script>
  // acknowlegde friend button 
  function acknowledgeFriend() {
    var stretchFriendFrame = document.getElementById("ifrm2");
    var shrinkYourFrame = document.getElementById("ifrm1");
    var ignoreButton = document.getElementById("ignore");
    var acknowledgeButton = document.getElementById("acknowledge");
    // we make our friends frame visible
    stretchFriendFrame.style.visibility = "visible";
    // we shrink our frame
    shrinkYourFrame.style.width = "49%";
    // we hide the acknowledge friend button
    acknowledgeButton.style.visibility = "hidden";
    // we reveal the ignore friend button
    document.getElementById("replaceButton").appendChild(ignoreButton);
    ignoreButton.style.visibility = "visible";
  }
</script>

</body>

</html>
